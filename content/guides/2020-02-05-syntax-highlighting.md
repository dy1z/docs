---
title: "How to add syntax highlighting to HTML emails"
slug: "syntax-highlight-code-html-emails"
description: "Using PrismJS, Markdown fenced code blocks, and Events in Maizzle to add syntax highlighting to HTML emails."
date: 2020-02-05
---

If you want to share a block of code in an HTML email _and_ have it look nice, it usually involves a lot of manual work: escaping, formatting, tokenizing, styling tokens...

With Maizzle however, we can use JavaScript libraries to do that work for us ðŸ’…

## Getting started

Let's create a new Maizzle project.

Open a terminal window and run the `new` command:

```sh
maizzle new syntax-highlight
```

That will create a `syntax-highlight` folder at your current location, clone the [Starter](https://github.com/maizzle/maizzle) in it, and install NPM dependencies for you.

OK, now open the `syntax-highlight` folder in your editor.

## Markdown

We'll use Markdown to add our code block to the email template. We _could_ manually add `<pre>` and `<code>` tags, but with Markdown we get a few things done for us out of the box:

- it will automatically format (escape) code to be displayed on screen
- it adds the necessary `language-xxxx` class to the `<code>` tag

Edit your template and add a [`{% markdown %}`](/docs/markdown/#block) tag somewhere in your content - anywhere a `<pre>` element would be allowed.

We'll be using the [Promotional template](https://github.com/maizzle/maizzle/blob/master/src/templates/promotional.njk) from Maizzle, so we'll add the markdown block right after the `<p>` from the first article:

```handlebars
{% markdown %}
```js
function foo(bar) {
    var a = 42,
        b = 'Prism';
    return a + bar(b);
}
`&zwnj;``
{% endmarkdown %}
```

<div class="bg-gray-100 border-l-4 border-gradient-b-orange-dark p-4 mb-4 text-md" role="alert">
  <div class="text-gray-600">
    <p>There's a hidden <code class="shiki-inline">&amp;zwnj;</code> character in the closing of the fenced code block above (in <code class="shiki-inline">```</code> above <code class="shiki-inline">{% endmarkdown %}</code>). This is needed for nesting fenced code blocks on this page. If you're copy-pasting the example above, make sure to delete and replace all <code class="shiki-inline">```</code> with your own.</p>
  </div>
</div>

Now run `maizzle serve` to start the development server, and open `http://localhost:3000/promotional.html` in a browser. 

You'll see something like this:

<img src="https://res.cloudinary.com/maizzle/image/upload/v1580899257/guides/syntax-no-highlight.png" alt="Code without syntax highlighting">

Not very pretty, is it?

Let's use PrismJS to make it look better.

## PrismJS

Install the PrismJS library in your project by running this command in the terminal at your project's root:

```sh
npm install prismjs
```

### Theme

We'll also need a PrismJS theme to make the code block pretty.
Choose one of the default themes, or see [prism-themes](https://github.com/PrismJS/prism-themes) for more.

We'll go with the [Synthwave '84 Theme](https://github.com/PrismJS/prism-themes/blob/master/themes/prism-synthwave84.css):

<img src="https://res.cloudinary.com/maizzle/image/upload/v1580895198/guides/synthwave84-prism.png" width="255" class="mb-4" alt="Synthwave '84 theme preview">

Save [prism-synthwave84.css](https://raw.githubusercontent.com/PrismJS/prism-themes/master/themes/prism-synthwave84.css) to the `src/assets/css/custom` directory in your project, 
and import it in your `src/assets/css/main.css`:

```css
/* Your custom CSS resets for email */
@import "custom/reset";

/* Tailwind components that are generated by plugins */
@import "tailwindcss/components";

/**
 * @import here any custom components - classes that you'd want loaded
 * before the Tailwind utilities, so that the utilities could still
 * override them.
*/
@import "custom/prism-synthwave84";

/* Tailwind utility classes */
@import "tailwindcss/utilities";

/* Your custom utility classes */
@import "custom/utilities";
```

We'll get back to this file later.

## Events

In order to use PrismJS to highlight fenced code blocks in our email template, we'll use [Events](/docs/events/) in Maizzle.

### afterConfig

Using the `afterConfig` event allows us to programmatically set config options, after the environment config has been generated.

Edit `config.js` and add an `events` object:

```js
const Prism = require('prismjs')

module.exports = {
  // ...
  events: {
    async afterConfig(config) {
      config.markdown = {
        highlight: function(code, lang, callback) {
          return Prism.highlight(code, Prism.languages[lang], lang)
        },
        langPrefix: 'language-',
      }
    },
  },
}
```

We're now using PrismJS is used as a custom highlighter function for our Markdown renderer. 
See [marked.js docs](https://marked.js.org/#/USING_ADVANCED.md#options) an explanation of all the options.

If we run `maizzle build` again, we see our code looking the same. 

Why is it not working?

If you look at the source code, you'll see PrismJS _did_ do something - it tokenized the code, which is just a fancy way of saying it wrapped pieces of text in `<span>` tags.

We don't notice any difference, because of CSS purging and clean-up in Maizzle. 

Since we're not actually using any of the classes in it, CSS inside `prism-synthwave84.css` is purged. 
We can fix this by telling [postcss-purgecss](/docs/code-cleanup/#purgecss) to ignore this file, by wrapping its contents in comments, like so:

```css
/*! purgecss start ignore */
  /* contents of the file here... */
/*! purgecss start ignore */
```

Now, running `maizzle build` will finally show us we're making some progress:

<img src="https://res.cloudinary.com/maizzle/image/upload/v1580902472/guides/syntax-partial-highlight.png" class="mb-4" alt="Partial syntax highlighting">

It looks like that because the wrapping `<pre>` has no `class="language-xxxx"`, and the theme requires it. Which leads us to:

### afterRender

We can use the `afterRender` Event in Maizzle to manipulate the rendered HTML _before_ Transformers are applied. This means, before CSS inlining takes place.

All the theme really needs is a `language-` class on all `<pre>` tags. 
It doesn't care if it's `language-html` or `language-js`.
We can take advantage of this and avoid having to parse the HTML - we'll just use a dumb regex instead.

Add this event after the `afterConfig` one:

```js
afterRender(html, config) {
  return html.replace(/<pre>/g, '<pre class="language-">')
},
```

Nothing fancy here: just a simple replace to add a class. No need to parse the HTML.

Your `events {}` config object should now look like this:

```js
events: {
  async afterConfig(config) {
    config.markdown = {
      highlight: function(code, lang, callback) {
        return Prism.highlight(code, Prism.languages[lang], lang)
      },
      langPrefix: 'language-',
    }
  },
  afterRender(html, config) {
    return html.replace(/<pre>/g, '<pre class="language-">')
  },
},
```

## Email client support

Some email clients require some extra steps in order to render our code blocks properly.

### Gmail

Gmail will override our inline `white-space: pre;` and set it to `pre-wrap`.
This results in code wrapping, instead of showing a horizontal scrollbar.

Fix it by adding the following CSS at the beginning of the `prism-synthwave84.css` file:

```css
@screen all {
  pre {
    @apply whitespace-pre !important;
  }
}
```

### Outlook

The padding on `<pre>` doesn't work in Outlook, and we'll also see a `line-height` issue.

We can fix these by wrapping `{% markdown %}` tags inside a table that we only show in Outlook. We then style this table inline, like so:

```handlebars
<!--[if mso]><table width="100%"><tr><td style="background: #2a2139; padding: 24px;"><![endif]-->
{% markdown %}
```js
function foo(bar) {
    var a = 42,
        b = 'Prism';
    return a + bar(b);
}
`&zwnj;``
{% endmarkdown %}
<!--[if mso]></td></tr></table><![endif]-->
```

## Inline code blocks

We can adjust the Synthwave '84 theme to style `inline code`, too.

Change this:

```css
/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}
```

to this:

```css
/* Inline code */
:not(pre) > code {
  @apply bg-gray-100 border border-solid border-gray-300 text-red-400 text-sm px-8 py-4 rounded whitespace-normal;
}
```

## Production build

We've been working with `config.js` until now, which is configured for local development.
This means CSS isn't inlined, and most email optimizations are off.

When you're satisfied with the dev preview, run `maizzle build production` and use the `build_production/promotional.html` file for sending.

## Resources

- [Repository](https://github.com/maizzle/example-syntax-highlight) for this tutorial
- [PrismJS](https://prismjs.com/)
- [Synthwave '84](https://github.com/PrismJS/prism-themes/blob/master/themes/prism-synthwave84.css) theme
- [Markdown in email](/docs/markdown/)
- Maizzle [Events](/docs/events/)
- Testing: [Email on Acid](https://www.emailonacid.com/), [SendTest.Email](https://sendtest.email)
